generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

enum Role {
  BORROWER
  LENDER
  ADMIN
}

enum KycStatus {
  pending
  approved
  rejected
}

enum TicketStatus {
  OPEN
  IN_PROGRESS
  RESOLVED
  CLOSED
  USER_REPLIED
  ADMIN_REPLIED
}

enum TicketPriority {
  low
  medium
  high
  critical
}

enum TicketCategory {
  technical
  account
  payment
  general
}

enum LoanStatus {
  PENDING
  UNDER_REVIEW
  APPROVED
  REJECTED
}

enum LoanRequestStatus {
  PENDING
  ACCEPTED
  REJECTED
  CANCELLED
}

model User {
  id        Int              @id @default(autoincrement())
  name      String
  email     String           @unique
  phone     String?
  password  String
  role      Role
  profilePicture String?
  isEmailVerified Boolean @default(false)
  isKYCVerified Boolean @default(false)
  passwordResetToken String?
  passwordResetExpires DateTime?
  createdAt DateTime         @default(now())
  updatedAt DateTime         @updatedAt

  borrowerProfile BorrowerProfile?
  lenderProfile   LenderProfile?
  supportTickets  SupportTicket[]
  ticketReplies   SupportTicketReply[]
  borrowerRequests LoanRequest[] @relation("BorrowerRequests")
  lenderRequests   LoanRequest[] @relation("LenderRequests")
  sentMessages      ChatMessage[] @relation("SentMessages")
  receivedMessages  ChatMessage[] @relation("ReceivedMessages")
}

model BorrowerProfile {
  id                            Int       @id @default(autoincrement())
  userId                        Int       @unique
  full_name                     String
  age                           Int?
  gender                        String?
  contact_number                String?
  email                         String?
  aadhaar_number                String?
  pan_number                    String?
  aadhaar_image                 String?
  pan_image                     String?
  employment_type               String?
  monthly_income                Int?
  years_of_job_stability        Int?
  previous_loans                String?
  loan_type                     String?
  total_loan_amount_taken       Int?
  current_outstanding_loan      Int?
  loan_defaults_last_12_months  Int?
  average_emi_per_month         Int?
  missed_emi_payments           Int?
  credit_card_repayment_behavior String?
  approx_monthly_expenses       Int?
  major_spending_categories     String?
  maintains_savings_monthly     Boolean?
  pays_bills                    Boolean?
  types_of_bills                String?
  missed_utility_payments       Int?
  creditScore                   Int?       // Generated by AI/ML Model
  kyc_status                    KycStatus @default(pending)
  created_at                    DateTime  @default(now())
  updated_at                    DateTime  @default(now()) @updatedAt

  user User @relation(fields: [userId], references: [id])
  loanApplications LoanApplication[]
}

model LenderProfile {
  id                   Int       @id @default(autoincrement())
  userId               Int       @unique
  aadhar_number        String?
  pan_number           String?
  aadhar_image_path    String?
  pan_image_path       String?
  available_funds      Int?
  interest_rate        Float?
  kyc_status           KycStatus @default(pending)
  created_at           DateTime  @default(now())
  updated_at           DateTime  @default(now()) @updatedAt

  user User @relation(fields: [userId], references: [id])

  @@index([available_funds])
  @@index([kyc_status])
  @@index([interest_rate])
}

model LoanApplication {
  id                 Int        @id @default(autoincrement())
  borrowerId         Int
  loanAmount         Int
  loanPurpose        String
  loanTenureMonths   Int
  creditScore        Int?       // Generated by AI (application-specific)
  status             LoanStatus @default(PENDING)
  adminRemarks       String?
  createdAt          DateTime   @default(now())
  updatedAt          DateTime   @updatedAt

  borrower BorrowerProfile @relation(fields: [borrowerId], references: [id])
  loanRequests LoanRequest[]

  @@index([borrowerId])
  @@index([status])
  @@index([loanAmount])
  @@index([loanTenureMonths])
  @@index([creditScore])
}

model LoanRequest {
  id                 Int              @id @default(autoincrement())
  loanApplicationId  Int
  borrowerId         Int
  lenderId           Int
  initiatedBy        Role?            // BORROWER or LENDER - who sent the request (nullable for backward compatibility)
  status             LoanRequestStatus @default(PENDING)
  message            String?          @db.Text
  createdAt          DateTime         @default(now())
  updatedAt          DateTime         @updatedAt

  loanApplication LoanApplication @relation(fields: [loanApplicationId], references: [id], onDelete: Cascade)
  borrower        User           @relation("BorrowerRequests", fields: [borrowerId], references: [id])
  lender          User           @relation("LenderRequests", fields: [lenderId], references: [id])
  messages        ChatMessage[]

  @@unique([loanApplicationId, lenderId])
  @@index([borrowerId])
  @@index([lenderId])
  @@index([status])
  @@index([loanApplicationId])
  @@index([initiatedBy])
}

model ChatMessage {
  id            Int      @id @default(autoincrement())
  loanRequestId Int
  senderId      Int
  receiverId    Int
  message       String   @db.Text
  messageType   String   @default("text") // text, image, file, etc.
  isRead        Boolean  @default(false)
  readAt        DateTime?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  loanRequest LoanRequest @relation(fields: [loanRequestId], references: [id], onDelete: Cascade)
  sender      User        @relation("SentMessages", fields: [senderId], references: [id])
  receiver    User        @relation("ReceivedMessages", fields: [receiverId], references: [id])

  @@index([loanRequestId])
  @@index([senderId])
  @@index([receiverId])
  @@index([isRead])
  @@index([createdAt])
}

model SupportTicket {
  id               Int       @id @default(autoincrement())
  ticketId         String    @unique
  userId           Int
  category         TicketCategory
  priority         TicketPriority @default(medium)
  subject          String
  description      String    @db.Text
  steps            String?   @db.Text
  expectedBehavior String?   @db.Text
  actualBehavior   String?   @db.Text
  status           TicketStatus @default(OPEN)
  adminNote        String?   @db.Text
  resolvedAt       DateTime?
  resolvedBy       Int?
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt

  user    User                 @relation(fields: [userId], references: [id])
  replies SupportTicketReply[]

  @@index([userId])
  @@index([status])
  @@index([category])
  @@index([priority])
}

model SupportTicketReply {
  id         Int      @id @default(autoincrement())
  ticketId   Int
  userId     Int
  message    String   @db.Text
  isFromUser Boolean  @default(true)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  ticket SupportTicket @relation(fields: [ticketId], references: [id], onDelete: Cascade)
  user   User          @relation(fields: [userId], references: [id])

  @@index([ticketId])
}
